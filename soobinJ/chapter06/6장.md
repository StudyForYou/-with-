# 6장 타입스크립트 컴파일

## 6.1 자바스크립트의 런타임과 타입스크립트의 컴파일

### 1. 런타임과 컴파일타임

- 컴파일 타임: 소스코드가 컴파일러에 의해 기계어 코드로 변환되어 실행 가능한 프로그램이 되는 단계
- 런타임: 컴파일이 완료되어 프로그램이 메모리에 적재되어 실행되는 시간

### 2. 자바스크립트 런타임

- 자바스크립트 런타임
  - 자바스크립트가 실행되는 환경을 의미
  - 크롬, 사파리 같은 인터넷 브라우저, Node.js 등
- 구성 요소
  - 자바스크립트 엔진, 웹 API, 콜백 큐, 이벤트 루프, 렌더 큐

### 3. 타입스크립트의 컴파일

- 일반적으로 컴파일은 추상화 단계가 다른 고수준 언어에서 저수준 언어로 변환되는 과정으 ㄹ의미
- 타입스크립트는 tsc라고 불리는 컴파일러를 통해 자바스크립트 코드로 변환됨
  - 타입스크립트는 고수준 언어가 저수준 언어로 변환되는 것이 아닌 고수준 언어가 또 다른 고수준 언어로 변환되는 것
  - 트랜스파일이라고 부르기도 함
  - 타입스크립트 컴파일러를 소스 대 소스 컴파일러라고 지칭하기도 함
- 과정
  - 타입스크립트 소스코드를 타입스크립트 AST로 만듦 (tsc)
  - 타입 검사기가 AST를 확인하여 타입을 확인함 (tsc)
  - 타입스크립트 AST를 자바스크립트 소스로 변환함 (tsc)
  - 자바스크립트 소스코드를 자바스크립트 AST로 만듦 (런타임)
  - AST가 바이트 코드로 변환됨 (런타임)
  - 런타임에서 바이트 코드가 평가되어 프로그램이 실행됨 (런타임)
- 3단계부터는 타입을 확인하지 않음
  - 타입 정보는 타입을 확인하는 데만 쓰임
  - 최종적으로 만들어지는 프로그램에는 아무런 영향을 주지 못함
- 타입스크립트는 컴파일타임에 타입을 검사 -> 에러 발생 시 프로그램 실행되지 않음 -> 정적 타입 검사기라고 부름

## 6.2 타입스크립트 컴파일러의 동작

### 1. 코드 검사기로서의 타입스크립트 컴파일러

- 코드에 타입 오류가 없는지를 검사
- 코드 타입을 확인학 때문에 실행하지 않고도 오류를 발견할 수 있음
- 컴파일타임에 문법 에러와 타입 관련 에러를 모두 검출
- 타입 검사를 거쳐 코드를 안전하게 만든 이후에 타입스크립트 AST를 자바스크립트 코드로 변환함

### 2. 코드 변환기로서의 타입스크립트 컴파일러

- 타입스크립트 코드를 각자의 런타임 환경에서 동작할 수 있도록 구버전의 자바스크립트로 트랜스 파일함
- 트랜스파일이 완료된 자바스크립트 파일에서 타입 정보가 제거됨
- 자바스크립트로 컴파일되어야 브라우저는 코드를 이해하고 정상적으로 실행할 수 있음
- 자바스크립트 코드로 변환되는 과정과 타입 검사 독립적으로 동작
  - 타입 검사를 수행한 후 코드 변환을 시작하는데, 이때 타입 오류가 있더라도 일단 컴파일 진행함
  - 타입스크립트 코드의 타이핑이 잘못되어 발생하는 에러는 자바스크립트 실행 과정에서 런타임 에러로 처리됨
- 바벨과 차이점
  - tsc와 바벨은 소스코드를 ES5 이하의 자바스크립트 코드로 컴파일해준다는 점에서 동일
  - 하지만 tsc와 달리 바벨은 타입검사를 하지 않음

## 6.3 타입스크립트 컴파일러의 구조

- 컴파일러는 하나의 프로그램으로 이를 구현한 소스 파일이 존재함
- 단계
  - 스캐너: .ts 토큰화
  - 파서: 토큰 기반 AST 생성
  - 바인더: AST 노드 기반 심볼 생성
  - 체커: AST + 심볼 기반 타입 검사
  - 이미터: AST + 코드 기반 .js 생성

### 1. 프로그램(Program)

- 타입스크립트 컴파일러는 tsc 명령어로 실행됨
- 컴파일러는 tsconfig.json에 명시된 컴파일 옵션을 기반으로 컴파일을 수행함
- 전체적인 컴파일 과정을 관리하는 프로그램 객체 (인스턴스)가 생성됨
- 프로그램 객체는 컴파일할 타입스크립트 소스 파일과 소스 파일 내에서 임포트된 파일을 불러옴
- 가장 최초로 불러온 파일을 기준으로 컴파일 과정이 시작됨

### 2. 스캐너(Scanner)

- 타입스크립트 소스를 자바스크립트로 변환하기 위한 첫 번째 단계
- 타입스크립트 소스 파일을 어휘적으로 분석하여 토큰을 생성하는 역할을 함 (소스코드를 작은 단위로 나누어 의미 있는 토큰으로 변환하는 작업 수행)

### 3. 파서(Parser)

- 토큰 정보를 이용하여 AST 생성
- AST는 컴파일러가 동작하는 데 핵심 기반이 되는 자료 구조, 소스코드의 구조를 트리 형태로 표현
- AST의 최상위 노드는 타입스크립트 소스 파일, 최하위 노드는 파일 끝 지점으로 구성됨
- 토큰 목록을 활용하여 구문적 분석을 수행함
- 코드의 실질적인 구조를 노드 단위으 트리 형태로 표현함
- 각각의 노드는 코드상의 위치, 구문 종류, 코드 내용과 같은 정보를 담고 있음

### 4. 바인더(Binder)

- 체커 단계에서 타입 검사를 할 수 있도록 기반 마련하는 역할
- 타입 검사를 위해 심볼이라는 데이터 구조를 생성함
- 심볼은 이전 단계의 AST에서 선언된 타입의 노드 정보를 저장함
- 심볼을 생성하고 해당 심볼과 그에 대응하는 AST 노드를 연결하는 역할 수행

### 5. 체커(Checker)와 이미터(Emitter)

- 체커
  - 파서가 생성한 AST와 바인더가 생성한 심볼을 활용하여 타입 검사를 수행
  - 전체 컴파일 과정에서 타입 검사가 차지하는 비중이 큼 -> 파서의 소스 크기보다 체커의 소스 크기가 큼
  - AST의 노드를 탐색하면서 심볼 정보를 불러와 주어진 소스 파일에 대해 타입 검사를 진행
  - 체커의 타입 검사는 다음 컴파일 단계인 이미터에서 실행됨
  - checker.ts의 getDignostics() 험수를 사용해서 타입을 검증하고 타입 에러에 대한 정보를 보여줄 에러 메세지를 저장함
- 이미터
  - 타입스크립트 소스 파일을 변환하는 역할을 함
  - 타입스크립트 소스를 자바스크립트 파일과 타입 선언 파일로 생성함
  - 타입스크립트 소스 파일을 변환하는 과정에서 개발자가 설정한 타입스크립트 설정 파일을 읽어옴
  - 체커를 통해 코드에 대한 타입 검증 정보를 가져옴
  - emitter.ts 소스 파일 내부의 emitFiles() 함수를 사용하여 타입스크립트 소스 변환을 진행함
- 정리
  - tsc 명령어를 실행하여 프로그램 객체가 컴파일 과정을 시작함
  - 스캐너는 소스 파일을 토큰 단위로 분리함
  - 파서는 토큰을 이용하여 AST를 생성함
  - 바인더는 AST의 각 노드에 대응하는 심볼을 생성함, 심볼은 선언된 타입의 노드 정보를 담고 있음
  - 체커는 AST를 탐색하면서 심볼 정보를 활용하여 타입 검사를 수행
  - 타입 검사 결과 에러가 없다면 이미터를 사용해서 자바스크립트 소스 파일로 변환
